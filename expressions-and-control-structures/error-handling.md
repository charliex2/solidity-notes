# é”™è¯¯å¤„ç†

å¦‚æœå¼‚å¸¸åœ¨å­è°ƒç”¨ä¸­å‘ç”Ÿï¼Œnameå¼‚å¸¸ä¼šè‡ªåŠ¨å†’æ³¡åˆ°é¡¶å±‚ã€‚ä½†æ˜¯ä½çº§åˆ«çš„è°ƒç”¨ä¾‹å¦‚ï¼š`send`ã€`call`ã€`delegatecall`ã€`staticcall`çš„è°ƒç”¨é‡Œå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä»–ä»¬ä¼šè¿”å› `false`ã€‚æ‰€ä»¥å¦‚æœéœ€è¦ï¼Œéœ€è¦åœ¨è¿”å›å‰æ£€æŸ¥è¿”å›å€¼ã€‚

é”™è¯¯å‘ç”Ÿæ—¶ï¼Œä¼šè¿”å› error å®ä¾‹ã€‚å†…ç½®çš„é”™è¯¯ç±»å‹æœ‰ Error(string) å’Œ Panic(uint256) 

- Error ç”¨äºå¸¸è§„é”™è¯¯åœºæ™¯
- **Panic is used for errors that should not be present in bug-free code.**

### Panic é”™è¯¯

`assert` ä¼šäº§ç”Ÿ `Panic` é”™è¯¯ï¼Œå‡½æ•°åªèƒ½ç”¨äºæµ‹è¯•å†…éƒ¨é”™è¯¯ï¼Œæ£€æŸ¥è¡¨ä¸å˜é‡ã€‚æ­£ç¡®çš„å‡½æ•°ä»£ç æ°¸è¿œä¸ä¼šäº§ç”Ÿ Panicï¼Œç”šè‡³æ˜¯åŸºäºä¸€ä¸ªæ— æ•ˆçš„å¤–éƒ¨è¾“å…¥ã€‚å¦‚æœå‘ç”Ÿäº†ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€äº§ç”Ÿäº†ä¸€ä¸ªéœ€è¦ä½ ä¿®å¤çš„ bugã€‚è¯­è¨€åˆ†æå·¥å…·å¯ä»¥å¯¹ä½ çš„åˆçº¦è¿›è¡Œè¯„ä¼°åˆ†æå‡ºä¼šå¼•èµ· Panic çš„ æ¡ä»¶å’Œå‡½æ•°è°ƒç”¨ã€‚

ä¸‹åˆ—åœºæ™¯ä¼šå¼•å‘ Panic é”™è¯¯ï¼Œå…¶é”™è¯¯ç å¯ä»¥æŒ‡æ˜é”™è¯¯çš„ç±»å‹ï¼š

- `0x00`: ç¼–è¯‘å™¨æ’å…¥çš„é€šç”¨ panicï¼›
- `0x01`: assert() åˆ¤æ–­æŸä¸ªå‚æ•°ä¸º falseï¼›
- `0x11`: åœ¨ unchecked{} ä»£ç å—ä¸­çš„ä¸Šã€ä¸‹æº¢å‡ºï¼›
- `0x12`: é™¤ä»¥0 æˆ–è€… å– 0 çš„æ¨¡äº§ç”Ÿçš„é”™è¯¯ï¼›
- `0x21`: å°†ä¸€ä¸ªå¤ªå¤§æˆ–è€…è´Ÿæ•°è½¬ä¸ºæšä¸¾ç±»å‹ï¼›
- `0x22`: èŒƒå›´ä¸€ä¸ªæœªæ­£ç¡®ç¼–ç çš„ storage å­—èŠ‚æ•°ç»„ï¼›
- `0x31`: å¯¹ä¸€ä¸ªç©ºæ•°ç»„è¿›è¡Œ pop æ“ä½œï¼›
- `0x32`: æ•°ç»„ã€bytesNã€æˆ–è€…æ•°ç»„åˆ‡ç‰‡ä¸‹æ ‡è¶…é™æˆ–è€…ä¸‹æ ‡ä¸ºè´Ÿæ•°ï¼›
- `0x41`: åˆ†é…äº†å¤ªå¤šå†…å­˜æˆ–è€…åˆ›å»ºäº†å¤ªå¤§çš„æ•°ç»„ï¼›
- `0x51`: If you call a zero-initialized variable of internal function type.ğŸ¤”ï¼Ÿ

### Error é”™è¯¯

`require` å‡½æ•°äº§ç”Ÿä¸€ä¸ªå¸¦æˆ–è€…ä¸å¸¦é”™è¯¯ä¿¡æ¯çš„ `Error`ã€‚`require` ä¸»è¦æ€•ç”¨æ¥å¤„ç†è¿è¡Œæ—¶çš„é”™è¯¯ï¼Œä¾‹å¦‚ç”¨æ¥åˆ¤æ–­è¾“å…¥å€¼å’Œè°ƒç”¨å¤–éƒ¨åˆçº¦å‡½æ•°çš„è¿”å›å€¼çš„åˆæ³•æ€§ã€‚

ç›®å‰å°šä¸æ”¯æŒç”¨ require è§¦å‘è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼Œä¸è¿‡å¯ä»¥ä½¿ç”¨ `if(!condition) revert CustomError();`

ç¼–è¯‘å™¨ä¼šåœ¨ä»¥ä¸‹åœºæ™¯è§¦å‘ Error

- `require(x)` ä¸º false æ—¶ï¼›
- ä½¿ç”¨ `revert` å‡½æ•°æ—¶ï¼›
- è°ƒç”¨ä¸€ä¸ªå¤–éƒ¨åˆçº¦çš„å‡½æ•°ï¼Œä½†æ˜¯è¿™ä¸ªåˆçº¦å†…å¹¶æ²¡æœ‰ä»£ç ï¼›
- å½“ä½ çš„åˆçº¦é€šè¿‡ public å‡½æ•°è°ƒç”¨æ”¶åˆ°äº†ä¸€ç¬” Ether è½¬è´¦ï¼Œä½†æ˜¯æ²¡æœ‰ payable ä¿®é¥°ï¼ˆåŒ…æ‹¬ constructor å’Œ fallback å‡½æ•°ï¼‰
- å½“ä½ çš„åˆçº¦é€šè¿‡ getter å‡½æ•°æ¥æ”¶ Etherã€‚

### é”™è¯¯ç±»å‹ä¸å®šçš„åœºæ™¯

å¦‚æœé”™è¯¯æ¥è‡ªå¤–éƒ¨è°ƒç”¨è¢«è½¬å‘ï¼Œè¿™æ„å‘³ç€ Error å’Œ Panic éƒ½æœ‰å¯èƒ½è¢«è¢«è§¦å‘ã€‚

- transfer() å¤±è´¥ï¼›

- é€šè¿‡æ¶ˆæ¯è°ƒç”¨ï¼ˆmessage callï¼‰è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œä½†æ˜¯è¯¥å‡½æ•°æœªæ­£ç¡®å®Œæˆã€‚å¯èƒ½æœ‰çš„åŸå› å¾ˆå¤šï¼Œæ¯”å¦‚ gas è€—å°½ï¼Œæ²¡æœ‰åŒ¹é…çš„å‡½æ•°ï¼Œè‡ªèº«æŠ›å‡ºå¼‚å¸¸ï¼›

  è¿™é‡Œè¯´çš„å‡½æ•°ä¸åŒ…æ‹¬ callã€sendã€ delegatecallã€callcodeã€staticcall ç­‰ä½çº§è°ƒç”¨ï¼Œè¿™äº›å‡½æ•°å¦‚æœå¤±è´¥ä»…ä¼šè¿”å› falseã€‚

- é€šè¿‡ new å…³é”®è¯åˆ›å»ºä¸€ä¸ªåˆçº¦ï¼Œä½†æ˜¯åˆ›å»ºè¿‡ç¨‹æœªå®Œæˆã€‚



åœ¨å†…éƒ¨ï¼ŒSolidity é‡åˆ°é”™è¯¯ä¼šè¿›è¡Œä¸€ä¸ª revert æ“ä½œï¼ˆæ“ä½œç ä¸º `0xfd`ï¼‰ï¼Œè¯¥æ“ä½œç ä¼šå¼•èµ· EVM å›æ»šæœ¬æ¬¡äº‹åŠ¡çš„æ‰€æœ‰çŠ¶æ€å˜æ›´ã€‚

**åœ¨æ‰€æœ‰çš„åœºæ™¯ä¸­è°ƒç”¨è€…ï¼ˆ`caller`ï¼‰å¯ä»¥ä½¿ç”¨ try/catch å¤„ç†é”™è¯¯ï¼Œä½†æ˜¯è¢«è°ƒç”¨è€… (`callee`) ä¸­çš„çŠ¶æ€å˜æ›´è¿˜æ˜¯ä¼šè¢«å›æ»šã€‚**

> åœ¨ Solidity 0.8.0 ç‰ˆæœ¬ä¹‹å‰ï¼Œ Panic é”™è¯¯ä½¿ç”¨ invalid æ“ä½œç ï¼Œå…¶ä¼šæ¶ˆè€—æ‰æœ¬æ¬¡è°ƒç”¨æ‰€æœ‰çš„ gasã€‚åœ¨ Metropolis æœ¬æ ‡ç­¾ã€‚require è§¦å‘é”™è¯¯ä¹Ÿä¼šæ¶ˆè€—æ‰æ‰€æœ‰çš„ gasã€‚



### revert

revert å¯ä»¥é€šè¿‡ revert å£°æ˜æˆ–è€… revert å‡½æ•°è§¦å‘ã€‚

```javascript
# revert æŒ‡ä»¤å¯ä»¥ç›´æ¥æŠ›å‡ºä¸€ä¸ªè‡ªå®šä¹‰é”™è¯¯
revert CustomError(arg1, arg2);

# revert function
revert(); //  å¼•å‘ revert ï¼Œä¸å¸¦ä»»ä½•é”™è¯¯ä¿¡æ¯
revert("description"); // å¼•å‘ä¸€ä¸ª Error(string) é”™è¯¯
```

ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯å®ä¾‹ä¼šæ¯”ä½¿ç”¨å­—ç¬¦ä¸²æè¿°çš„é”™è¯¯æ›´åŠ èŠ‚çº¦ gasï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ç”¨è‡ªå®šä¹‰é”™è¯¯åæè¿°é”™è¯¯ï¼Œé”™è¯¯åæœ€ç»ˆç¼–ç åªæœ‰ 4 å­—èŠ‚ã€‚è€Œé•¿çš„å­—ç¬¦ä¸²æè¿°éœ€è¦é€šè¿‡ NatSpec æ¥å®ç°ï¼Œé‚£ä¸ªè¿™ä¸ª gas èŠ±é”€å°±æ— æ³•ä¼°è®¡äº†ã€‚

```js
// SPDX-LICENSE-Identifier: GPL-3.0

pragma solidity ^0.8.4;

contract VendingMachine {
    address owner;
    error Unauthorized();

    function buy(uint amount) public payable {
        if(amount > msg.value / 2 ether){
            revert("Not enough Ether provided.");
        }

        // å¦ä¸€ç§å®ç°æ–¹å¼
        require(
            amount <= msg.value / 2 ether,
            "Not enough Ether provided"
        )
        // ...
    }

    function withdraw() public {
        if(msg.sender != owner)
            revert Unauthorized();
        payable(msg.sender).transfer(address(this).balance);
    }
}
```

ä¸Šé¢ä¾‹å­ä¸­æåˆ° `if(!condition revert(...));`å’Œ`require(condition, ...)` åªè¦å…¶ä¼ å…¥çš„å‚æ•°æ²¡æœ‰å‰¯ä½œç”¨ï¼Œé‚£ä¹ˆä»–ä»¬å°±æ˜¯ç­‰æ•ˆçš„ã€‚

`require()`å‡½æ•°è·Ÿå…¶ä»–å‡½æ•°ä¸€è‡´ï¼Œå¦‚æœä¼ å…¥çš„å‚æ•°å¦‚æœæ˜¯å‡½æ•°æˆ–è€…è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆä»–ä»¬ä¼šåœ¨ require å‡½æ•°æ‰§è¡Œå‰æ‰§è¡Œï¼Œå³ä½¿ require çš„æ¡ä»¶æ˜¯ trueã€‚ä¾‹å¦‚

```js
require(condition, f());
```

#### Error(string) é”™è¯¯ä¿¡æ¯çš„ç¼–ç 

Error(string) åœ¨ EVM æ˜¯ abi ç¼–ç çš„ã€‚ä¾‹å¦‚ `revert("not enough Ether provided."); `æœ€ç»ˆè¿”å›çš„é”™è¯¯æ•°æ®ä¸º`ï¼š

```js
0x08c379a0                     // Function selector for Error(string)
0x0000000000000000000000000000000000000000000000000000000000000020 // Data offset
0x000000000000000000000000000000000000000000000000000000000000001a // String length
0x4e6f7420656e6f7567682045746865722070726f76696465642e000000000000 // String data
```

è¿™äº›é”™è¯¯ä¿¡æ¯å¯ä»¥è¢« `try/catch` å–å›ã€‚

> åœ¨ 0.4.13 ç‰ˆæœ¬ä¸­æœ‰ä¸€ä¸ª å…³é”®è¯ throw ä¸ revert() åœ¨è¯­ä¹‰ä¸Šä¸€è‡´ï¼Œæ­¤åç‰ˆæœ¬å·²ç»åºŸé™¤ï¼Œå¹¶åœ¨ 0.5.0 ç‰ˆæœ¬ä¸­ç§»é™¤ã€‚

### try/catch

å¤–éƒ¨è°ƒç”¨çš„å¤±è´¥ï¼Œå¯ä»¥é€šè¿‡ try/catch è¯­å¥æ¥æ•è·ï¼›

```js
// SPDX-License-Identifier: GPL-3.0

pragma solidity ^0.8.1;

interface DataFeed {
    function getData(address token) external returns (uint value);
}

contract FeedConsumer {
    DataFeed feed;
    uint errorCount;

    function rate(address token) public returns (uint value, bool success){
        require(errorCount < 10);

        try feed.getData(token) returns (uint v){
            return (v, true);
        } catch Error(string memory /**reson**/){
            // å¦‚æœåœ¨ getData ä¸­ revert è¢«æ‰§è¡Œï¼Œé‚£ä¹ˆä¼šè¢«æ­¤å¤„æ•è·ï¼Œå¹¶æä¾›ä¸€ä¸ªé”™è¯¯å­—ç¬¦ä¸²
            errorCount++;
            return (0, false);
        } catch Panic(uint /**code**/){
            // å¦‚æœ getData æŠ›å‡º panicï¼Œä¾‹å¦‚é™¤ä»¥ 0 é”™è¯¯æˆ–è€…æº¢å‡ºé”™è¯¯ã€‚å…¶é”™è¯¯ç å¯ä»¥ç”¨æ¥åˆ¤æ–­é”™è¯¯çš„ç±»å‹
            errorCount++;
            return (0, false);
        } catch (bytes memory /**lowLevelData**/){
            // åœ¨ revert() ä½¿ç”¨æ—¶è§¦å‘
            errorCount ++;
            return (0, false);
        }
    }
}
```



try å…³é”®è¯åå¿…é¡»è·Ÿéšç€ å¤–éƒ¨å‡½æ•°è°ƒç”¨æˆ–è€…åˆçº¦åˆ›å»º(`new ContractName()`)è¯­å¥ã€‚è¯¥è¡¨è¾¾å¼å†…éƒ¨çš„é”™è¯¯å°†ä¸ä¼šè¢«æ•è·ï¼ˆä¾‹å¦‚è¯¥è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„å‡½æ•°ï¼Œå†…éƒ¨è¿˜æœ‰è°ƒç”¨å¦ä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼‰ï¼Œä»…ä»…åªèƒ½æ•è·è¯¥ external call è‡ªèº«å‘ç”Ÿçš„é”™è¯¯ã€‚

returns ä¸æ˜¯æ˜¯å¯é€‰çš„ï¼Œè¯¥å¤„å£°æ˜çš„éœ€è¦ä¸è¿™ä¸ªå¤–éƒ¨è°ƒç”¨è¿”å›çš„å€¼ä¸€è‡´ã€‚å¦‚æœæ²¡æœ‰é”™è¯¯å‘ç”Ÿï¼Œnameè¿™äº›åœ¨ returns å£°æ˜çš„å€¼éƒ½ä¼šè¢«èµ‹å€¼ï¼Œsuccess ä»£ç å—ä¸­çš„ä»£ç ä¹Ÿä¼šè¢«æ‰§è¡Œã€‚

ç›®å‰ Solidity é’ˆå¯¹ä¸åŒçš„é”™è¯¯ç±»å‹æ”¯æŒä¸åŒçš„ catch å—ã€‚å¦‚æœé”™è¯¯æ˜¯ç”± revert("reasonStringf") æˆ–è€… require(false, "reasonString")ï¼Œæˆ–è€…æ˜¯ç”±å†…éƒ¨é”™è¯¯å¼•èµ·çš„è¿™äº›é”™è¯¯ï¼Œé‚£ä¹ˆå°±èƒ½æ•è·åˆ° Error(string memory reason)ã€‚

It is planned to support other types of error data in the future. The string `Error` is currently parsed as is and is not treated as an identifier.  ğŸ¤”

å½“ error çš„signature æ²¡æœ‰åŒ¹é…ä¸Šã€å½“è§£æé”™è¯¯ä¿¡æ¯å‡ºé”™ã€å½“æ²¡æœ‰é”™è¯¯ä¿¡æ¯æä¾›çš„æ—¶å€™ï¼Œ`catch (bytes memory lowLevelData)`ä¼šè¢«æ‰§è¡Œã€‚è¯¥ catch çš„å£°æ˜çš„å˜é‡ï¼Œå¯ä»¥è®¿é—®åˆ°ä½çº§çš„é”™è¯¯æ•°æ®ï¼›

> å¦‚æœæ˜¯è§£æ external call çš„è¿”å›å€¼å‡ºé”™ï¼Œé‚£ä¹ˆåªä¼šåœ¨æœ¬åˆçº¦è§¦å‘ä¸€ä¸ªé”™è¯¯ï¼Œå¹¶ä¸ä¼šè¢« catch å—æ•è·ï¼›å¦‚æœæ˜¯è§£æ `catch Error(string memory reason)` ä¸­è§£æé”™è¯¯ä¿¡æ¯å‡ºé”™ï¼Œé‚£ä¹ˆè¯¥é”™è¯¯ä¼šè¢« catch å—æ•è·ï¼›

> å¦‚æœæ‰§è¡Œåˆ°äº† catch-blockï¼Œå¤–éƒ¨è°ƒç”¨å¼•èµ·çš„ state-changing ä¼šè¢«å›æ»šã€‚å¦‚æœæˆåŠŸæ‰§è¡Œåˆ°äº† success å—ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¢«å›æ»šã€‚å¦‚æœè¢«å›æ»šåï¼Œå°†ä¼šç»§ç»­æ‰§è¡Œ catch å—ï¼Œæˆ–è€… try/catch è‡ªèº«ä¹Ÿ revert äº†ï¼ˆä¾‹å¦‚è§£æé”™è¯¯ä¿¡æ¯å‡ºé”™ï¼‰ã€‚

> å¼•èµ·é”™è¯¯çš„åŸå› å¤šç§å¤šæ ·ã€‚ä¸è¦å‡å®šæ‰€æœ‰çš„é”™è¯¯ä¿¡æ¯ç›´æ¥æ¥è‡ªäºåˆçº¦ã€‚è¿™ä¸ªé”™è¯¯å¯èƒ½æ˜¯è°ƒç”¨é“¾æ·±å¤„å¼•èµ·çš„ï¼Œä½ è°ƒç”¨çš„åˆçº¦ä»…ä»…æ˜¯è½¬å‘äº†è¿™ä¸ªé”™è¯¯ã€‚
>
> é”™è¯¯å¯èƒ½æ˜¯ gas ç”¨å®Œå’Œnot a deliberate error conditionï¼šè°ƒç”¨è€…ï¼ˆcallerï¼‰æ€»æ˜¯åœ¨è°ƒç”¨å¤–éƒ¨åˆçº¦çš„æ—¶å€™ä¿ç•™ 1/64 çš„gasï¼Œä»¥ä¿è¯å¤–åŒ…åˆçº¦ç”¨å…‰äº† gas è¿˜èƒ½æœ‰éƒ¨åˆ† gas ä¿ç•™ã€‚
